<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fort Worth Property Scout - Investment Analyzer</title>
    <style>
        :root { --primary:#1E3A5F; --secondary:#2E7D32; --accent:#FF6B35; --success:#4CAF50; --danger:#F44336; --bg:#0D1117; --card-bg:#161B22; --text:#E6EDF3; --text2:#8B949E; --border:#30363D; --hover:#21262D; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
        
        .header { background:linear-gradient(135deg,var(--primary),var(--bg)); padding:1.5rem 2rem; border-bottom:1px solid var(--border); }
        .header-top { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;gap:1rem; }
        .logo-section { display:flex; align-items:center; gap:1rem; }
        .logo { width:48px;height:48px;background:var(--secondary);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px; }
        .title h1 { font-size:1.5rem; }
        .title p { color:var(--text2);font-size:0.875rem; }
        
        .assumptions { background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:1rem 2rem; }
        .assumptions h3 { font-size:0.9rem;margin-bottom:0.75rem;color:var(--accent); }
        .assumptions-grid { display:flex;flex-wrap:wrap;gap:1rem; }
        .assumption { background:var(--hover);padding:0.5rem 1rem;border-radius:8px;font-size:0.8rem; }
        .assumption strong { color:var(--success); }
        
        .url-analyzer { background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:0 2rem 1rem; }
        .url-analyzer h3 { font-size:0.9rem;margin-bottom:0.75rem; }
        .url-form { display:flex;gap:0.5rem;flex-wrap:wrap; }
        .url-input { flex:1;min-width:200px;padding:0.75rem;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:0.9rem; }
        .analyze-btn { background:var(--secondary);border:none;color:#fff;padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:500; }
        
        .nav { display:flex;gap:0.5rem;padding:1rem 2rem;background:var(--card-bg);border-bottom:1px solid var(--border);flex-wrap:wrap; }
        .nav button { background:transparent;border:none;color:var(--text2);padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:500; }
        .nav button.active { background:var(--secondary);color:#fff; }
        
        .main { padding:1.5rem 2rem;max-width:1600px;margin:0 auto; }
        
        .kpi-grid { display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem; }
        @media(max-width:1200px){.kpi-grid{grid-template-columns:repeat(2,1fr)}}
        .kpi-card { background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:1.25rem; }
        .kpi-label { font-size:0.75rem;color:var(--text2);text-transform:uppercase; }
        .kpi-value { font-size:2rem;font-weight:700; }
        .kpi-value.success{color:var(--success)}.kpi-value.danger{color:var(--danger)}.kpi-value.accent{color:var(--accent)}
        
        .table-card { background:var(--card-bg);border:1px solid var(--border);border-radius:12px;overflow:hidden; }
        .table-header { padding:1rem 1.25rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem; }
        .table-filters { display:flex;gap:0.5rem;flex-wrap:wrap; }
        .filter-btn { background:var(--hover);border:1px solid var(--border);color:var(--text2);padding:0.5rem 1rem;border-radius:6px;font-size:0.8rem;cursor:pointer; }
        .filter-btn.active { background:var(--secondary);color:#fff; }
        table { width:100%;border-collapse:collapse; }
        th { text-align:left;padding:0.75rem;background:var(--hover);color:var(--text2);font-size:0.75rem;text-transform:uppercase; }
        td { padding:0.75rem;border-bottom:1px solid var(--border); }
        tr:hover td { background:var(--hover);cursor:pointer; }
        .status-badge { padding:0.25rem 0.75rem;border-radius:20px;font-size:0.75rem; }
        .status-badge.pass{background:rgba(76,175,80,0.2);color:var(--success)}
        .status-badge.fail{background:rgba(244,67,54,0.2);color:var(--danger)}
        .status-badge.duplex{background:rgba(255,107,53,0.2);color:var(--accent)}
        
        .modal-overlay { display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;padding:1rem; }
        .modal-overlay.active { display:flex; }
        .modal { background:var(--card-bg);border:2px solid var(--border);border-radius:16px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto; }
        .modal-header { padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between; }
        .modal-title { font-size:1.25rem;font-weight:600; }
        .modal-close { background:none;border:none;color:var(--text2);font-size:1.5rem;cursor:pointer; }
        .modal-body { padding:1.5rem; }
        .detail-grid { display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1rem; }
        .detail-card { background:var(--hover);border-radius:8px;padding:1rem; }
        .detail-label { font-size:0.7rem;color:var(--text2);text-transform:uppercase; }
        .detail-value { font-size:1.25rem;font-weight:600; }
        .analysis-section { background:var(--hover);border-radius:8px;padding:1rem;margin-bottom:1rem; }
        .analysis-section h4 { font-size:0.875rem;margin-bottom:0.75rem;color:var(--text2); }
        .analysis-row { display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid var(--border); }
        .analysis-row:last-child { border:none; }
        
        .footer { text-align:center;padding:2rem;color:var(--text2);font-size:0.75rem;border-top:1px solid var(--border);margin-top:2rem; }
        .source-tag { display:inline-block;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.65rem;margin-right:0.5rem; }
        .source-tag.zillow{background:rgba(0,123,255,0.2);color:#007bff}
        .source-tag.tax{background:rgba(255,107,53,0.2);color:var(--accent)}
        .source-tag.auction{background:rgba(156,39,176,0.2);color:#9c27b0}
        
        .best-deal { background:linear-gradient(135deg,rgba(255,107,53,0.1),rgba(76,175,80,0.1));border:2px solid var(--accent);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem; }
        .best-deal h3 { color:var(--accent);margin-bottom:1rem; }
        .best-deal-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem; }
        .best-stat { text-align:center; }
        .best-stat-label { font-size:0.7rem;color:var(--text2); }
        .best-stat-value { font-size:1.5rem;font-weight:700;color:var(--success); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <div class="logo-section">
                <div class="logo">üè†</div>
                <div class="title">
                    <h1>Fort Worth Property Scout</h1>
                    <p>Investment Property Analyzer ‚Ä¢ Updated Feb 26, 2026</p>
                </div>
            </div>
        </div>
        
        <div class="assumptions">
            <h3>üìã Investment Criteria (Feb 2026)</h3>
            <div class="assumptions-grid">
                <div class="assumption">üéØ Target: <strong>&lt;$270K listing</strong></div>
                <div class="assumption">üí∞ Offer: <strong>15% below listing</strong></div>
                <div class="assumption">üìà Interest: <strong>5.25%</strong></div>
                <div class="assumption">üíµ Max Cash Out: <strong>$100K</strong></div>
                <div class="assumption">‚úÖ CoC Target: <strong>&gt;8%</strong></div>
                <div class="assumption">üìä Cash Flow: <strong>&gt;$0/mo</strong></div>
            </div>
        </div>
        
        <div class="url-analyzer">
            <h3>üîç Analyze a Property (Paste Zillow URL)</h3>
            <div class="url-form">
                <input type="text" class="url-input" id="propertyUrl" placeholder="Paste Zillow property URL here...">
                <button class="analyze-btn" onclick="analyzeUrl()">Analyze</button>
            </div>
        </div>
    </header>
    
    <nav class="nav">
        <button class="active" onclick="showTab('all')">All Deals</button>
        <button onclick="showTab('best')">üî• Best Buys</button>
        <button onclick="showTab('pass')">‚úÖ Pass</button>
        <button onclick="showTab('fail')">‚ùå Fail</button>
    </nav>
    
    <main class="main">
        <div class="best-deal">
            <h3>üî• TOP DEAL - 7652 Colorado Creek Ct (DUPLEX)</h3>
            <div class="best-deal-grid">
                <div class="best-stat">
                    <div class="best-stat-label">Price</div>
                    <div class="best-stat-value">$65K</div>
                </div>
                <div class="best-stat">
                    <div class="best-stat-label">Cash Flow</div>
                    <div class="best-stat-value">+$1,699/mo</div>
                </div>
                <div class="best-stat">
                    <div class="best-stat-label">Cash-on-Cash</div>
                    <div class="best-stat-value">25.2%</div>
                </div>
                <div class="best-stat">
                    <div class="best-stat-label">Total Cash Out</div>
                    <div class="best-stat-value">$80,950</div>
                </div>
            </div>
        </div>
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Properties</div>
                <div class="kpi-value" id="totalCount">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Under $270K Listing</div>
                <div class="kpi-value accent" id="under270">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Pass Criteria</div>
                <div class="kpi-value success" id="passCount">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Avg Cash Flow</div>
                <div class="kpi-value" id="avgCf">$0</div>
            </div>
        </div>
        
        <div class="table-card">
            <div class="table-header">
                <h3>Property Listings</h3>
                <div class="table-filters">
                    <button class="filter-btn active" onclick="filterTable('all')">All</button>
                    <button class="filter-btn" onclick="filterTable('pass')">Pass</button>
                    <button class="filter-btn" onclick="filterTable('fail')">Fail</button>
                    <button class="filter-btn" onclick="filterTable('duplex')">Multi-Unit</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Address</th>
                        <th>Listed</th>
                        <th>Offer</th>
                        <th>Type</th>
                        <th>Cash Flow</th>
                        <th>CoC</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="propertyTable"></tbody>
            </table>
        </div>
    </main>
    
    <div class="modal-overlay" id="propertyModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Property Details</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    
    <footer class="footer">
        Fort Worth Property Scout ‚Ä¢ Investment Criteria: &lt;$270K listing, 5.25% interest, $100K max cash<br>
        Updated: February 26, 2026
    </footer>

    <script>
        // Properties loaded from API
        let properties = [];
        
        async function loadProperties() {
            try {
                const res = await fetch('/api/properties');
                const data = await res.json();
                properties = data.properties || [];
                
                // Update timestamp
                if (data.updated) {
                    const date = new Date(data.updated);
                    document.querySelector('.title p').textContent = `Investment Property Analyzer ‚Ä¢ Updated ${date.toLocaleDateString()}`;
                }
                
                renderTable();
                loadTelemetry();
            } catch (e) {
                console.error('Failed to load properties:', e);
            }
        }
        
        // Load telemetry stats
        async function loadTelemetry() {
            try {
                const res = await fetch('/api/telemetry');
                const data = await res.json();
                
                if (data.today && data.today.total > 0) {
                    console.log('Telemetry today:', data.today);
                }
            } catch (e) {
                console.error('Telemetry error:', e);
            }
        }
        
        function formatMoney(amount) {
            return '$' + (amount || 0).toLocaleString();
        }
        
        function getSourceTag(source) {
            const tags = { zillow:'Zillow', tax:'Tax', auction:'Auction' };
            return `<span class="source-tag ${source || 'zillow'}">${tags[source] || source || 'Zillow'}</span>`;
        }
        
        function renderTable() {
            const tbody = document.getElementById('propertyTable');
            tbody.innerHTML = '';
            
            let filtered = properties;
            if (currentFilter === 'pass') filtered = properties.filter(p => p.status === 'pass');
            if (currentFilter === 'fail') filtered = properties.filter(p => p.status === 'fail');
            if (currentFilter === 'duplex') filtered = properties.filter(p => p.type && p.type.toLowerCase().includes('duplex'));
            
            filtered.forEach(p => {
                const tr = document.createElement('tr');
                tr.onclick = () => showProperty(p.id);
                const addressHtml = p.url 
                    ? `<a href="${p.url}" target="_blank" onclick="event.stopPropagation()" style="color:var(--text);text-decoration:none;">${p.address} ‚Üó</a>`
                    : p.address;
                const statusLabel = p.status === 'pass' ? '‚úÖ Pass' : (p.status === 'duplex' ? 'üè† Multi' : '‚ùå Fail');
                tr.innerHTML = `
                    <td>${getSourceTag(p.source)}${addressHtml}</td>
                    <td>${formatMoney(p.listed)}</td>
                    <td>${formatMoney(p.offer)}</td>
                    <td>${p.type || 'SFR'}</td>
                    <td class="${p.cashFlow >= 0 ? 'success' : 'danger'}">${formatMoney(p.cashFlow)}/mo</td>
                    <td class="${p.coc >= 8 ? 'success' : p.coc < 0 ? 'danger' : ''}">${(p.coc || 0).toFixed(1)}%</td>
                    <td><span class="status-badge ${p.status === 'pass' ? 'pass' : p.status === 'duplex' ? 'duplex' : 'fail'}">${statusLabel}</span></td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update KPIs
            document.getElementById('totalCount').textContent = properties.length;
            document.getElementById('under270').textContent = properties.filter(p => p.listed <= 270000).length;
            document.getElementById('passCount').textContent = properties.filter(p => p.status === 'pass').length;
            const cfVals = properties.filter(p => p.cashFlow > 0).map(p => p.cashFlow);
            const avgCf = cfVals.length ? cfVals.reduce((a,b) => a + b, 0) / cfVals.length : 0;
            document.getElementById('avgCf').textContent = formatMoney(avgCf) + '/mo';
        }
        
        function filterTable(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderTable();
        }
        
        function showTab(tab) {
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if (tab === 'best') currentFilter = 'pass';
            else if (tab === 'pass') currentFilter = 'pass';
            else if (tab === 'fail') currentFilter = 'fail';
            else currentFilter = 'all';
            renderTable();
        }
        
        function showProperty(id) {
            const p = properties.find(x => x.id === id);
            if (!p) {
                // Try by address if id not found
                return;
            }
            
            const viewBtn = p.url ? `<a href="${p.url}" target="_blank" class="analyze-btn" style="display:inline-block;text-decoration:none;margin-bottom:1rem;">üîó View on Zillow</a>` : '';
            
            document.getElementById('modalTitle').textContent = p.address;
            document.getElementById('modalBody').innerHTML = `
                ${viewBtn}
                <div class="detail-grid">
                    <div class="detail-card">
                        <div class="detail-label">Listed Price</div>
                        <div class="detail-value">${formatMoney(p.listed)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Offer Price</div>
                        <div class="detail-value">${formatMoney(p.offer)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Type</div>
                        <div class="detail-value">${p.type}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Total Cash Out</div>
                        <div class="detail-value">${formatMoney(p.cashOut)}</div>
                    </div>
                </div>
                <div class="analysis-section">
                    <h4>üí∞ Investment Analysis</h4>
                    <div class="analysis-row"><span class="analysis-label">Cash Flow</span><span>${formatMoney(p.cashFlow)}/mo</span></div>
                    <div class="analysis-row"><span class="analysis-label">Cash-on-Cash</span><span>${p.coc.toFixed(1)}%</span></div>
                    <div class="analysis-row"><span class="analysis-label">Status</span><span>${p.status === 'pass' ? '‚úÖ PASS' : '‚ùå FAIL'}</span></div>
                </div>
                ${p.notes ? `<div class="analysis-section"><h4>üìù Notes</h4><p>${p.notes}</p></div>` : ''}
            `;
            document.getElementById('propertyModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('propertyModal').classList.remove('active');
        }
        
        function analyzeUrl() {
            const url = document.getElementById('propertyUrl').value;
            if (!url) return;
            
            const btn = document.querySelector('.analyze-btn');
            btn.textContent = 'Analyzing...';
            btn.disabled = true;
            
            fetch('/api/scrape?url=' + encodeURIComponent(url))
                .then(r => r.json())
                .then(data => {
                    btn.textContent = 'Analyze';
                    btn.disabled = false;
                    
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    
                    alert(`Found: ${data.address || 'Unknown'}\nPrice: $${data.price || 'N/A'}\nSource: ${data.source}`);
                })
                .catch(e => {
                    btn.textContent = 'Analyze';
                    btn.disabled = false;
                    alert('Error: ' + e.message);
                });
        }
        
        // Load properties on page load
        loadProperties();
    </script>
    
    <!-- New Features -->
    <script src="storage.js"></script>
    <script src="keyboard-shortcuts.js"></script>
</body>
</html>
